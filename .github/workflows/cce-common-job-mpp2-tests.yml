on:
  workflow_call:
  
    inputs:
      NODE_VERSION:
        required: true
        type:     string
      TEST_SUITE:
        required: true
        type:     string
      ENVIRONMENT:
        required: true
        type:     string
      SECRETS_PREFIX:
        required: true
        type:     string

jobs:
  run_tests_template:
    name: ${{ inputs.TEST_SUITE }}
    environment: ${{ inputs.ENVIRONMENT }}
    runs-on: ubuntu-latest
    steps:
    - name: üîé List all environment variables
      run: env | sort

    - name: Checkout
      uses: actions/checkout@v4

    - name: üìó Use node.js ${{ inputs.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ inputs.NODE_VERSION }}

    - name: üîë Keys for cache
      run: echo "nodejs_ver=$(node -v)-$(npm -v)" >> $GITHUB_ENV

    - name: üîÅ Restore cache (npm dependencies)
      uses: actions/cache@v4
      id: cache
      with:
        path: node_modules
        key:  ${{ runner.os }}-${{ env.nodejs_ver }}-${{ hashFiles('package-lock.json') }}

    - name: üîΩ Install dependencies
      if: steps.cache.outputs.cache-hit != 'true'
      run: npm ci

    - name: üìü Install Playwright driver
      run: npx playwright install chrome

    - name: üîê Configure AWS
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region:            ${{ secrets.AWS_DEFAULT_REGION }}
        mask-aws-account-id:   true

    - name: üîë Pull ${{ inputs.SECRETS_PREFIX }} config into .env.${{ inputs.SECRETS_PREFIX == 'staging' && 'stage' || 'prod' }} file
      uses: cleanchoice/cce-aws-secrets-manager-read-action@main
      with:
        secret-id:          cce-${{ inputs.SECRETS_PREFIX }}-martech-playwright-template-config-file
        append-to-env-file: .env.${{ inputs.SECRETS_PREFIX == 'staging' && 'stage' || 'prod' }}

    - name: üîë Pull ${{ inputs.SECRETS_PREFIX }} variables into local environment variables
      uses: cleanchoice/cce-aws-secrets-manager-read-action@main
      with:
        secret-id:        cce-${{ inputs.SECRETS_PREFIX }}-martech-playwright-template-env-vars
        keys-as-env-vars: true

    - name: üß™ Run ${{ inputs.TEST_SUITE }} tests
      run: xvfb-run npm run ${{ env[format('{0}_{1}', inputs.TEST_SUITE, inputs.ENVIRONMENT)] }}

    - name: üìù Upload tests report to S3 bucket
      if: always()
      working-directory: html_report
      env:
        REPORT_DIR: html_report_${{ inputs.TEST_SUITE }}
      run: aws s3 cp . s3://cce-${{ inputs.SECRETS_PREFIX }}-martech-playwright-template-reports/${{ env.REPORT_DIR }}_$(date +'%m_%d_%y')_${{ github.run_id }} --recursive

    - name: üîî Notify Slack
      if: failure()
      env:
        COLOR:                  '#E01E5A'
        LOGO:                   ':x:'
        MESSAGE:                'failed'
        CI_PIPELINE_URL:        https://github.com/${{github.repository}}/actions/runs/${{github.run_id}}
        SLACK_TEMPLATE:         test *MPP 2.0 (suite ${{ github.event_name == 'schedule' && 'ALL' || inputs.TEST_SUITE }})* has
        SLACK_TRIGGER:          ${{ github.event_name }}
        SLACK_TRIGGER_USERNAME: ${{ github.triggering_actor }}
        TEST_SUITE_REPORT_URL:  https://martech-playwright-reports.${{ inputs.ENVIRONMENT == 'prod' && 'cleanchoiceenergy.com' || 'stage-cleanchoiceenergy.com' }}/html_report_${{ inputs.TEST_SUITE }}_$(date +'%m_%d_%y')_${{ github.run_id }}/index.html
      run: |
        curl -X POST \
        -H 'Content-type: application/json' \
        --data "{\"channel\":\"$SLACK_CHANNEL\",\"username\":\"Github\",\"attachments\":[{\"color\":\"${{ env.COLOR }}\",\"text\":\"${{ inputs.ENVIRONMENT == 'PROD' && '‚≠ê :test_tube:' || ':test_tube:' }} ${{ env.LOGO }} Pod B ${{ inputs.ENVIRONMENT }}: ${{ env.SLACK_TEMPLATE }} ${{ env.MESSAGE }}, <${{ env.CI_PIPELINE_URL }}|view logs>, <${{ env.TEST_SUITE_REPORT_URL }}|${{ inputs.TEST_SUITE }} playwirght report>, <$SLACK_USER> (${{ env.SLACK_TRIGGER == 'schedule' && 'launched via ‚è∞' || format('launched by {0} via {1}', env.SLACK_TRIGGER_USERNAME, env.SLACK_TRIGGER) }}, runID ${{ github.run_id }})\",\"footer\":\"Time: $(TZ=$TZ date)\"}]}" \
        $SLACK_WEBHOOK