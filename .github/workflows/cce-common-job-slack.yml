on:
  workflow_call:
    
    inputs:
      ENVIRONMENT:
        required: true
        type:     string
      CI_PIPELINE_URL:
        required: true
        type:     string
      STATUS:
        required: true
        type:     string
      SLACK_TEMPLATE:
        required: true
        type:     string
      SLACK_TRIGGER:
        required: true
        type:     string
      SLACK_TRIGGER_USERNAME:
        required: true
        type:     string
      TEST_SUITES:
        required: true
        type:     string

jobs:
  slack_template:
    name: ${{ inputs.ENVIRONMENT }}
    runs-on: ubuntu-latest
    env:
      SECRETS_PREFIX:  ${{ inputs.ENVIRONMENT == 'STAGE' && 'staging' || 'prod'}}
    steps:
      - name: üîé List all environment variables
        run: env | sort

      - name: üîê Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:            ${{ secrets.AWS_DEFAULT_REGION }}
          mask-aws-account-id:   true

      - name: üîë Pull ${{ env.SECRETS_PREFIX }} variables into local environment variables
        uses: cleanchoice/cce-aws-secrets-manager-read-action@main
        with:
          secret-id:        cce-${{ env.SECRETS_PREFIX }}-martech-playwright-template-env-vars
          keys-as-env-vars: true

      - name: üîî Notify Slack
        env:
          COLOR:   '#2EB67D'
          LOGO:    ':white_check_mark:'
          MESSAGE: 'succeeded'
        run: |
          suites=$(echo ${{ inputs.TEST_SUITES }} | cut -d'[' -f2 | cut -d']' -f1 | sed 's/,/ /g' | sed "s/'//g" | tr ' ' '\n')
          reports='( playwright reports - '
          for suite_name in $suites
          do
            suite_report_url="<https://martech-playwright-reports.${{ inputs.ENVIRONMENT == 'prod' && 'cleanchoiceenergy.com' || 'stage-cleanchoiceenergy.com' }}/html_report_$(echo $suite_name)_$(date +'%m_%d_%y')_${{ github.run_id }}/index.html|$suite_name>"
            reports+="$suite_report_url "
          done
          reports+=')'

          curl -X POST \
          -H 'Content-type: application/json' \
          --data "{\"channel\":\"$SLACK_CHANNEL\",\"username\":\"Github\",\"attachments\":[{\"color\":\"${{ env.COLOR }}\",\"text\":\"${{ inputs.ENVIRONMENT == 'PROD' && '‚≠ê :test_tube:' || ':test_tube:' }} ${{ env.LOGO }} Pod B ${{ inputs.ENVIRONMENT }}: ${{ inputs.SLACK_TEMPLATE }} ${{ env.MESSAGE }}, <${{ inputs.CI_PIPELINE_URL }}|view logs>${{ inputs.STATUS == 'failure' && ', <$SLACK_USER>' || ' ' }} (${{ inputs.SLACK_TRIGGER == 'schedule' && 'launched via ‚è∞' || format('launched by {0} via {1}', inputs.SLACK_TRIGGER_USERNAME, inputs.SLACK_TRIGGER) }}, runID ${{ github.run_id }}) $reports\",\"footer\":\"Time: $(TZ=$TZ date)\"}]}" \
          $SLACK_WEBHOOK
