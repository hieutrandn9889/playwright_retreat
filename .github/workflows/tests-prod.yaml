name: Tests
run-name: ðŸ§ª Tests

on:
  #schedule:
  #  - cron: '0 6 * * 1-5' # 9:00 AM Kyiv time (Kyiv is UTC+3, so 6:00 UTC)
  push:
    branches:
      - template
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to run the tests against'
        required: true
        default: 'PROD'
        type: choice
        options:
          - PROD
          - STAGE
      test_suite:
        description: 'Test suite(s) to run. Available suites: CHAT_E2E_TESTS, SOFTSERVE_BULLIES_TESTS, BOOKRETREATS_E2E_TESTS, BLOCKCHAIN_TESTS, GMAIL_TESTS'
        required: true
        default: 'ALL'
        type: string

env:
  ENV_PREFIX:              ${{ github.event.inputs.environment }}
  SLACK_CHANNEL:           ${{ vars.SLACK_CHANNEL }}
  SLACK_WEBHOOK:           ${{ vars.SLACK_WEBHOOK }}
  SLACK_USER:              ${{ vars.SLACK_USER }}
  CI_PIPELINE_URL:         "https://github.com/alexzavg/playwright_retreat/actions/runs/${{ github.run_id }}"
  TZ:                      ${{ vars.TZ }}
  NODE_VERSION:            22.x

jobs:
  set-env-vars:
    runs-on: ubuntu-22.04
    outputs:
      ALL_TESTS: ${{ steps.set-vars.outputs.ALL_TESTS }}
      CHAT_E2E_TESTS: ${{ steps.set-vars.outputs.CHAT_E2E_TESTS }}
      SOFTSERVE_BULLIES_TESTS: ${{ steps.set-vars.outputs.SOFTSERVE_BULLIES_TESTS }}
      BOOKRETREATS_E2E_TESTS: ${{ steps.set-vars.outputs.BOOKRETREATS_E2E_TESTS }}
      BLOCKCHAIN_TESTS: ${{ steps.set-vars.outputs.BLOCKCHAIN_TESTS }}
      GMAIL_TESTS: ${{ steps.set-vars.outputs.GMAIL_TESTS }}
    steps:
      - id: set-vars
        run: |
          echo "ALL_TESTS=${{ vars[format('ALL_TESTS_{0}', github.event.inputs.environment)] }}" >> $GITHUB_OUTPUT
          echo "CHAT_E2E_TESTS=${{ vars[format('CHAT_E2E_TESTS_{0}', github.event.inputs.environment)] }}" >> $GITHUB_OUTPUT
          echo "SOFTSERVE_BULLIES_TESTS=${{ vars[format('SOFTSERVE_BULLIES_TESTS_{0}', github.event.inputs.environment)] }}" >> $GITHUB_OUTPUT
          echo "BOOKRETREATS_E2E_TESTS=${{ vars[format('BOOKRETREATS_E2E_TESTS_{0}', github.event.inputs.environment)] }}" >> $GITHUB_OUTPUT
          echo "BLOCKCHAIN_TESTS=${{ vars[format('BLOCKCHAIN_TESTS_{0}', github.event.inputs.environment)] }}" >> $GITHUB_OUTPUT
          echo "GMAIL_TESTS=${{ vars[format('GMAIL_TESTS_{0}', github.event.inputs.environment)] }}" >> $GITHUB_OUTPUT

  set-matrix:
    needs: set-env-vars
    runs-on: ubuntu-22.04
    outputs:
      suite-matrix: ${{ steps.set-matrix.outputs.suite-matrix }}
    steps:
      - id: set-matrix
        run: |
          BASE_SUITES=("CHAT_E2E_TESTS" "SOFTSERVE_BULLIES_TESTS" "BOOKRETREATS_E2E_TESTS" "BLOCKCHAIN_TESTS" "GMAIL_TESTS")
          ENV_PREFIX="$ENV_PREFIX"
          if [[ "${{ github.event.inputs.test_suite }}" == "ALL" ]]; then
            for suite in "${BASE_SUITES[@]}"; do
              ALL_SUITES+=("${suite}_${ENV_PREFIX}")
            done
          else
            IFS=',' read -ra SELECTED <<< "${{ github.event.inputs.test_suite }}"
            for suite in "${SELECTED[@]}"; do
              ALL_SUITES+=("${suite}_${ENV_PREFIX}")
            done
          fi
          SUITES_JSON=$(printf '%s\n' "${ALL_SUITES[@]}" | jq -R . | jq -c -s .)
          echo "suite-matrix=$SUITES_JSON" >> $GITHUB_OUTPUT
        env:
          ENV_PREFIX: ${{ env.ENV_PREFIX }}

  cache-deps:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Use node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Install dependencies
        run: |
          npm install
          npm install -g ts-node
          npx playwright install chrome
      - name: Cache node_modules and Playwright browsers
        id: cache-all
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            ~/.cache/ms-playwright
          key: ${{ runner.os }}-node-browsers-${{ hashFiles('**/package-lock.json') }}

  e2e_tests:
    needs: [set-env-vars, set-matrix, cache-deps]
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        suite: ${{ fromJson(needs.set-matrix.outputs.suite-matrix) }}
      fail-fast: false
    env:
      ALL_TESTS:               ${{ needs.set-env-vars.outputs.ALL_TESTS }}
      CHAT_E2E_TESTS:          ${{ needs.set-env-vars.outputs.CHAT_E2E_TESTS }}
      SOFTSERVE_BULLIES_TESTS: ${{ needs.set-env-vars.outputs.SOFTSERVE_BULLIES_TESTS }}
      BOOKRETREATS_E2E_TESTS:  ${{ needs.set-env-vars.outputs.BOOKRETREATS_E2E_TESTS }}
      BLOCKCHAIN_TESTS:        ${{ needs.set-env-vars.outputs.BLOCKCHAIN_TESTS }}
      GMAIL_TESTS:             ${{ needs.set-env-vars.outputs.GMAIL_TESTS }}
      REPORT_URL:              https://alexzavg.github.io/playwright_retreat/${{ matrix.suite }}
      ENV_PREFIX:              ${{ github.event.inputs.environment }}
      SLACK_CHANNEL:           ${{ vars.SLACK_CHANNEL }}
      SLACK_WEBHOOK:           ${{ vars.SLACK_WEBHOOK }}
      SLACK_USER:              ${{ vars.SLACK_USER }}
      CI_PIPELINE_URL:         "https://github.com/alexzavg/playwright_retreat/actions/runs/${{ github.run_id }}"
      TZ:                      ${{ vars.TZ }}
      NODE_VERSION:            22.x
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore node_modules and Playwright browsers cache
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            ~/.cache/ms-playwright
          key: ${{ runner.os }}-node-browsers-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-browsers-

      - name: Install dependencies (if needed)
        run: |
          if [ ! -d node_modules ] || [ -z "$(ls -A node_modules)" ]; then
            npm install
            npm install -g ts-node
            npx playwright install chrome
          fi

      - name: Create .env file
        run: |
          ENV_FILE=".env.${{ env.ENV_PREFIX | toLower }}"
          CONFIG_SECRET="CONFIG_${{ env.ENV_PREFIX }}"
          echo "${{ secrets[CONFIG_SECRET] }}" > $ENV_FILE

      - name: Run E2E tests
        run: xvfb-run npm run ${{ env[matrix.suite] }}

      - name: ðŸ§¼ Clean previous report folder
        if: always()
        run: |
          rm -rf ${{ matrix.suite }}
          mkdir -p ${{ matrix.suite }}
          cp -r html_report/* ${{ matrix.suite }}/ || echo "No report found to copy"

      - name: ðŸ›° Deploy suite report to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ${{ matrix.suite }}
          destination_dir: ${{ matrix.suite }}

      - name: Notify Slack
        if: always()
        run: |
          STATUS="${{ job.status }}"
          COLOR="#2EB67D"
          EMOJI=":white_check_mark:"
          SLACK_TAG=""
          if [ "$STATUS" == "failure" ]; then
            COLOR="#E01E5A"
            EMOJI=":x:"
            SLACK_TAG="<${{ env.SLACK_USER }}>"
          elif [ "$STATUS" == "cancelled" ]; then
            COLOR="#808080"
            EMOJI=":black_square_for_stop:"
          fi

          REPORT_URL="https://alexzavg.github.io/playwright_retreat/${{ matrix.suite }}/"
          echo ""
          echo "ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥"
          echo "ðŸŸ© REPORT URL FOR ${STATUS^^}: ${REPORT_URL}"
          echo "ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥"
          echo ""

          curl -X POST -H 'Content-type: application/json' --data "{
            \"channel\":\"$SLACK_CHANNEL\",
            \"username\":\"Github\",
            \"attachments\":[{
              \"color\":\"$COLOR\",
              \"text\":\"$EMOJI Test suite *${{ matrix.suite }}* finished with status *$STATUS*. :book: <${{ env.CI_PIPELINE_URL }}|LOGS>, :bar_chart: <$REPORT_URL|REPORT> $SLACK_TAG\",
              \"footer\":\"Time: $(TZ=$TZ date)\"
            }]
          }" $SLACK_WEBHOOK
