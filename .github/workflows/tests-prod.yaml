name: Tests Prod
run-name: üß™ Tests Prod

on:
  push:
    branches:
      - template
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to run the tests against'
        required: true
        default: 'prod'
        type: choice
        options:
          - PROD
      test_suite:
        description: 'Test suite(s) to run'
        required: true
        default: 'ALL'
        type: choice
        options:
          - CHAT_E2E_TESTS_PROD
          - SOFTSERVE_BULLIES_TESTS_PROD
          - BOOKRETREATS_E2E_TESTS_PROD
          - ALL

env:
  ALL_TESTS_PROD:               ${{vars.ALL_TESTS_PROD}}
  CHAT_E2E_TESTS_PROD:          ${{vars.CHAT_E2E_TESTS_PROD}}
  SOFTSERVE_BULLIES_TESTS_PROD: ${{vars.SOFTSERVE_BULLIES_TESTS_PROD}}
  BOOKRETREATS_E2E_TESTS_PROD:  ${{vars.BOOKRETREATS_E2E_TESTS_PROD}}
  SLACK_CHANNEL:                ${{vars.SLACK_CHANNEL}}
  SLACK_WEBHOOK:                ${{vars.SLACK_WEBHOOK}}
  SLACK_USER:                   ${{vars.SLACK_USER}}
  CI_PIPELINE_URL:              "https://github.com/alexzavg/playwright_retreat/actions/runs/${{github.run_id}}"
  TZ:                           ${{vars.TZ}}
  NODE_VERSION:                 22.x

jobs:
  e2e_tests:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        suite: [CHAT_E2E_TESTS_PROD, SOFTSERVE_BULLIES_TESTS_PROD, BOOKRETREATS_E2E_TESTS_PROD]
      fail-fast: false
    env:
      REPORT_URL: https://alexzavg.github.io/playwright_retreat/${{ matrix.suite }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: üìó Use node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: üîΩ Install dependencies
        run: |
          npm install
          npm install -g ts-node
          npx playwright install chrome

      - name: üìù Create .env file
        run: echo "${{secrets.CONFIG_PROD}}" > .env.prod

      - name: ‚öôÔ∏è Run E2E tests
        if: ${{ inputs.test_suite == 'ALL' || inputs.test_suite == matrix.suite }}
        run: xvfb-run npm run ${{ env[matrix.suite] }}

      - name: üßº Clean previous report folder
        if: always()
        run: |
          rm -rf ${{ matrix.suite }}
          mkdir -p ${{ matrix.suite }}
          cp -r html_report/* ${{ matrix.suite }}/ || echo "No report found to copy"

      - name: üõ∞ Deploy suite report to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ${{ matrix.suite }}
          destination_dir: ${{ matrix.suite }}

      - name: Notify Slack
        if: always()
        run: |
          STATUS="${{ job.status }}"
          COLOR="#2EB67D"
          EMOJI=":white_check_mark:"
          if [ "$STATUS" == "failure" ]; then
            COLOR="#E01E5A"
            EMOJI=":x:"
          elif [ "$STATUS" == "cancelled" ]; then
            COLOR="#808080"
            EMOJI=":black_square_for_stop:"
          fi

          curl -X POST -H 'Content-type: application/json' --data "{
            \"channel\":\"$SLACK_CHANNEL\",
            \"username\":\"Github\",
            \"attachments\":[{
              \"color\":\"$COLOR\",
              \"text\":\"$EMOJI Test suite *${{ matrix.suite }}* finished with status *$STATUS*. :book: <${{ env.CI_PIPELINE_URL }}|LOGS>, :bar_chart: <https://alexzavg.github.io/playwright_retreat/${{ matrix.suite }}/|REPORT> <${{ env.SLACK_USER }}>\",
              \"footer\":\"Time: $(TZ=$TZ date)\"
            }]
          }" $SLACK_WEBHOOK
