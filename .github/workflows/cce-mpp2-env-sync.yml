name: MPP 2.0 Stage Env Sync
run-name: ğŸ”„ MPP 2.0 Stage Env Sync (${{ inputs.action }})

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Select ON or OFF for feature env data sync https://reltio-integration.dev-cleanchoiceenergy.com'
        required: true
        default: 'TURN ON'
        type: choice
        options:
          - TURN ON
          - TURN OFF

env:
  NODE_VERSION: 22.x

jobs:
  env_sync:
    name: ğŸ”„ Env sync (Stage)
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ” List all environment variables
        run: env | sort

      - name: Checkout
        uses: actions/checkout@v4

      - name: ğŸ“— Use node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ”‘ Keys for cache
        run: echo "nodejs_ver=$(node -v)-$(npm -v)" >> $GITHUB_ENV

      - name: ğŸ” Restore cache (npm dependencies)
        uses: actions/cache@v4
        id: cache
        with:
          path: node_modules
          key:  ${{ runner.os }}-${{ env.nodejs_ver }}-${{ hashFiles('package-lock.json') }}

      - name: ğŸ”½ Install dependencies
        if: steps.cache.outputs.cache-hit != 'true'
        run: npm ci

      - name: ğŸ“Ÿ Install Playwright driver
        run: npx playwright install chrome

      - name: ğŸ” Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:            ${{ secrets.AWS_DEFAULT_REGION }}
          mask-aws-account-id:   true

      - name: ğŸ”‘ Pull staging config into .env.stage file
        uses: cleanchoice/cce-aws-secrets-manager-read-action@main
        with:
          secret-id:          cce-staging-martech-playwright-template-config-file
          append-to-env-file: .env.stage

      - name: ğŸ”„ Env sync (Stage)
        run: xvfb-run npm run mpp2_stage_sync_${{ inputs.action == 'TURN ON' && 'on' || 'off' }}